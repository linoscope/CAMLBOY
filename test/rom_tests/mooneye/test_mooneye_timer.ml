open Camlboy_lib
module M = Mooneye_utils.Make(Cartridge_mbc1)

let%expect_test "div_timing.gb" =
  M.run_test_rom_and_print_framebuffer "timer/div_timing.gb";

  [%expect{|
    A:$00 F:ZN-- BC:$0305 DE:$080D HL:$1522 SP:$E000 PC:$4B2D
    008:-####-----------------------#-----------------------------------------------------------------------------------------------------------------------------------
    009:-#---#----####---------------------###-----#------####-------------###------------------------------------------------------------------------------------------
    010:-####----#----#---##-#------#-----#-------####---#----#---#-##----#---------------------------------------------------------------------------------------------
    011:-#-#-----######--#--##------#------##------#-----######---##--#----##-------------------------------------------------------------------------------------------
    012:-#--#----#-------#---#------#--------#-----#-----#--------#----------#------------------------------------------------------------------------------------------
    013:-#---#----####----##-#------#-----###------##-----####----#-------###-------------------------------------------------------------------------------------------
    014:---------------------#------------------------------------------------------------------------------------------------------------------------------------------
    015:------------------###-------------------------------------------------------------------------------------------------------------------------------------------
    024:-------------------##----------------------##-------#--------------------#####--------------------####-----##---------------------------------------------------
    025:-------------------##---------------------#--#-----##--------------------#-----------------------#----#---#--#--------------------------------------------------
    026:------------------#--#------#------------#----#-----#--------------------####-------#-------------####---#----#-------------------------------------------------
    027:------------------####-------------------#----#-----#--------------------#-----------------------#----#--#----#-------------------------------------------------
    028:-----------------#----#-------------------#--#------#--------------------#-----------------------#----#---#--#--------------------------------------------------
    029:-----------------#----#-----#--------------##------###-------------------#----------#-------------####-----##---------------------------------------------------
    032:-----------------####----------------------##------##---------------------###----------------------##------##---------------------------------------------------
    033:-----------------#---#--------------------#--#----#--#-------------------#---#--------------------#--#----#--#--------------------------------------------------
    034:-----------------####-------#------------#----#--#----#-----------------#-----------#------------#----#--#----#-------------------------------------------------
    035:-----------------#---#-------------------#----#--#----#-----------------#------------------------#----#--#----#-------------------------------------------------
    036:-----------------#---#--------------------#--#----#--#-------------------#---#--------------------#--#----#--#--------------------------------------------------
    037:-----------------####-------#--------------##------##---------------------###-------#--------------##------##---------------------------------------------------
    040:-----------------####----------------------##-------#--------------------#####-------------------####-----####--------------------------------------------------
    041:-----------------#---#--------------------#--#-----##--------------------#-----------------------#---#---#----#-------------------------------------------------
    042:-----------------#---#------#------------#----#-----#--------------------####-------#------------#---#----####--------------------------------------------------
    043:-----------------#---#-------------------#----#-----#--------------------#-----------------------#---#---#----#-------------------------------------------------
    044:-----------------#---#--------------------#--#------#--------------------#-----------------------#---#---#----#-------------------------------------------------
    045:-----------------####-------#--------------##------###-------------------#####------#------------####-----####--------------------------------------------------
    048:-----------------#----#------------------#####---#####-------------------#-------------------------##-------#---------------------------------------------------
    049:-----------------#----#------------------#-------#-----------------------#------------------------#--#-----##---------------------------------------------------
    050:-----------------######-----#------------####----####--------------------#----------#------------#----#---#-#---------------------------------------------------
    051:-----------------#----#------------------#-------#-----------------------#-----------------------#----#--#--#---------------------------------------------------
    052:-----------------#----#------------------#-------#-----------------------#------------------------#--#---#####--------------------------------------------------
    053:-----------------#----#-----#------------#-------#-----------------------######-----#--------------##-------#---------------------------------------------------
    064:---##-----------------------------------------------#-----------------------------------------------------------------------------------------------------------
    065:---##------###-----###----####-------------#-------------------------------###----------------------------------------------------------------------------------
    066:--#--#----#-------#------#----#---#-##----####------#-----####----#-###---#-------------------------------------------------------------------------------------
    067:--####-----##------##----######---##--#----#--------#----#----#---##--#----##-----------------------------------------------------------------------------------
    068:-#----#------#-------#---#--------#--------#--------#----#----#---#---#------#----------------------------------------------------------------------------------
    069:-#----#---###-----###-----####----#--------##-------#-----####----#---#---###-----------------------------------------------------------------------------------
    088:-----------------####----------------------###---#---#--------------------###----------------------###---#---#--------------------------------------------------
    089:-----------------#---#--------------------#---#--#--#--------------------#---#--------------------#---#--#--#---------------------------------------------------
    090:-----------------####-------#-------------#---#--#-#--------------------#-----------#-------------#---#--#-#----------------------------------------------------
    091:-----------------#---#--------------------#---#--###--------------------#-------------------------#---#--###----------------------------------------------------
    092:-----------------#---#--------------------#---#--#--#--------------------#---#--------------------#---#--#--#---------------------------------------------------
    093:-----------------####-------#--------------###---#---#--------------------###-------#--------------###---#---#--------------------------------------------------
    096:-----------------####----------------------###---#---#----------------------------------------------------------------------------------------------------------
    097:-----------------#---#--------------------#---#--#--#-----------------------------------------------------------------------------------------------------------
    098:-----------------#---#------#-------------#---#--#-#------------------------------------------------------------------------------------------------------------
    099:-----------------#---#--------------------#---#--###------------------------------------------------------------------------------------------------------------
    100:-----------------#---#--------------------#---#--#--#-----------------------------------------------------------------------------------------------------------
    101:-----------------####-------#--------------###---#---#---------------------------------------------------------------------------------------------------------- |}]

let%expect_test "tim00.gb" =
  M.run_test_rom_and_print_framebuffer "timer/tim00.gb";

  [%expect {|
    A:$00 F:ZN-- BC:$0305 DE:$080D HL:$1522 SP:$E000 PC:$4B2D
    008:-####-----------------------#-----------------------------------------------------------------------------------------------------------------------------------
    009:-#---#----####---------------------###-----#------####-------------###------------------------------------------------------------------------------------------
    010:-####----#----#---##-#------#-----#-------####---#----#---#-##----#---------------------------------------------------------------------------------------------
    011:-#-#-----######--#--##------#------##------#-----######---##--#----##-------------------------------------------------------------------------------------------
    012:-#--#----#-------#---#------#--------#-----#-----#--------#----------#------------------------------------------------------------------------------------------
    013:-#---#----####----##-#------#-----###------##-----####----#-------###-------------------------------------------------------------------------------------------
    014:---------------------#------------------------------------------------------------------------------------------------------------------------------------------
    015:------------------###-------------------------------------------------------------------------------------------------------------------------------------------
    024:-------------------##----------------------##----######------------------#####--------------------####-----##---------------------------------------------------
    025:-------------------##---------------------#--#---#-----------------------#-----------------------#----#---#--#--------------------------------------------------
    026:------------------#--#------#------------#----#--#####-------------------####-------#-------------####---#----#-------------------------------------------------
    027:------------------####-------------------#----#-------#------------------#-----------------------#----#--#----#-------------------------------------------------
    028:-----------------#----#-------------------#--#---#----#------------------#-----------------------#----#---#--#--------------------------------------------------
    029:-----------------#----#-----#--------------##-----####-------------------#----------#-------------####-----##---------------------------------------------------
    032:-----------------####----------------------##-------#---------------------###-----------------------#-----####--------------------------------------------------
    033:-----------------#---#--------------------#--#-----##--------------------#---#---------------------##----#----#-------------------------------------------------
    034:-----------------####-------#------------#----#---#-#-------------------#-----------#---------------#--------#--------------------------------------------------
    035:-----------------#---#-------------------#----#--#--#-------------------#---------------------------#------##---------------------------------------------------
    036:-----------------#---#--------------------#--#---#####-------------------#---#----------------------#----#----#-------------------------------------------------
    037:-----------------####-------#--------------##-------#---------------------###-------#--------------###----####--------------------------------------------------
    040:-----------------####----------------------##-------#--------------------#####---------------------##----######-------------------------------------------------
    041:-----------------#---#--------------------#--#-----##--------------------#------------------------#--#---#------------------------------------------------------
    042:-----------------#---#------#------------#----#---#-#--------------------####-------#------------#----#--#####--------------------------------------------------
    043:-----------------#---#-------------------#----#--#--#--------------------#-----------------------#----#-------#-------------------------------------------------
    044:-----------------#---#--------------------#--#---#####-------------------#------------------------#--#---#----#-------------------------------------------------
    045:-----------------####-------#--------------##-------#--------------------#####------#--------------##-----####--------------------------------------------------
    048:-----------------#----#--------------------##-------#--------------------#--------------------------#----####---------------------------------------------------
    049:-----------------#----#-------------------#--#-----##--------------------#-------------------------##----#---#--------------------------------------------------
    050:-----------------######-----#------------#----#-----#--------------------#----------#-------------#-#----#---#--------------------------------------------------
    051:-----------------#----#------------------#----#-----#--------------------#-----------------------#--#----#---#--------------------------------------------------
    052:-----------------#----#-------------------#--#------#--------------------#-----------------------#####---#---#--------------------------------------------------
    053:-----------------#----#-----#--------------##------###-------------------######-----#---------------#----####---------------------------------------------------
    064:---##-----------------------------------------------#-----------------------------------------------------------------------------------------------------------
    065:---##------###-----###----####-------------#-------------------------------###----------------------------------------------------------------------------------
    066:--#--#----#-------#------#----#---#-##----####------#-----####----#-###---#-------------------------------------------------------------------------------------
    067:--####-----##------##----######---##--#----#--------#----#----#---##--#----##-----------------------------------------------------------------------------------
    068:-#----#------#-------#---#--------#--------#--------#----#----#---#---#------#----------------------------------------------------------------------------------
    069:-#----#---###-----###-----####----#--------##-------#-----####----#---#---###-----------------------------------------------------------------------------------
    096:-----------------####----------------------###---#---#-------------------#####---------------------###---#---#--------------------------------------------------
    097:-----------------#---#--------------------#---#--#--#--------------------#------------------------#---#--#--#---------------------------------------------------
    098:-----------------#---#------#-------------#---#--#-#---------------------####-------#-------------#---#--#-#----------------------------------------------------
    099:-----------------#---#--------------------#---#--###---------------------#------------------------#---#--###----------------------------------------------------
    100:-----------------#---#--------------------#---#--#--#--------------------#------------------------#---#--#--#---------------------------------------------------
    101:-----------------####-------#--------------###---#---#-------------------#####------#--------------###---#---#-------------------------------------------------- |}]

let%expect_test "tim01.gb" =
  M.run_test_rom_and_print_framebuffer "timer/tim01.gb";

  [%expect{|
    A:$00 F:ZN-- BC:$0305 DE:$080D HL:$1522 SP:$E000 PC:$4B2D
    008:-####-----------------------#-----------------------------------------------------------------------------------------------------------------------------------
    009:-#---#----####---------------------###-----#------####-------------###------------------------------------------------------------------------------------------
    010:-####----#----#---##-#------#-----#-------####---#----#---#-##----#---------------------------------------------------------------------------------------------
    011:-#-#-----######--#--##------#------##------#-----######---##--#----##-------------------------------------------------------------------------------------------
    012:-#--#----#-------#---#------#--------#-----#-----#--------#----------#------------------------------------------------------------------------------------------
    013:-#---#----####----##-#------#-----###------##-----####----#-------###-------------------------------------------------------------------------------------------
    014:---------------------#------------------------------------------------------------------------------------------------------------------------------------------
    015:------------------###-------------------------------------------------------------------------------------------------------------------------------------------
    024:-------------------##----------------------##-----####-------------------#####--------------------####-----##---------------------------------------------------
    025:-------------------##---------------------#--#---#----#------------------#-----------------------#----#---#--#--------------------------------------------------
    026:------------------#--#------#------------#----#--#----#------------------####-------#-------------####---#----#-------------------------------------------------
    027:------------------####-------------------#----#---#####------------------#-----------------------#----#--#----#-------------------------------------------------
    028:-----------------#----#-------------------#--#--------#------------------#-----------------------#----#---#--#--------------------------------------------------
    029:-----------------#----#-----#--------------##-----####-------------------#----------#-------------####-----##---------------------------------------------------
    032:-----------------####----------------------##-------#---------------------###-----------------------#-----####--------------------------------------------------
    033:-----------------#---#--------------------#--#-----##--------------------#---#---------------------##----#----#-------------------------------------------------
    034:-----------------####-------#------------#----#---#-#-------------------#-----------#---------------#--------#--------------------------------------------------
    035:-----------------#---#-------------------#----#--#--#-------------------#---------------------------#------##---------------------------------------------------
    036:-----------------#---#--------------------#--#---#####-------------------#---#----------------------#----#----#-------------------------------------------------
    037:-----------------####-------#--------------##-------#---------------------###-------#--------------###----####--------------------------------------------------
    040:-----------------####----------------------##-----####-------------------#####---------------------##-----####--------------------------------------------------
    041:-----------------#---#--------------------#--#---#----#------------------#------------------------#--#---#----#-------------------------------------------------
    042:-----------------#---#------#------------#----#---####-------------------####-------#------------#----#--#----#-------------------------------------------------
    043:-----------------#---#-------------------#----#--#----#------------------#-----------------------#----#---#####-------------------------------------------------
    044:-----------------#---#--------------------#--#---#----#------------------#------------------------#--#--------#-------------------------------------------------
    045:-----------------####-------#--------------##-----####-------------------#####------#--------------##-----####--------------------------------------------------
    048:-----------------#----#--------------------##-------#--------------------#--------------------------#----####---------------------------------------------------
    049:-----------------#----#-------------------#--#-----##--------------------#-------------------------##----#---#--------------------------------------------------
    050:-----------------######-----#------------#----#-----#--------------------#----------#-------------#-#----#---#--------------------------------------------------
    051:-----------------#----#------------------#----#-----#--------------------#-----------------------#--#----#---#--------------------------------------------------
    052:-----------------#----#-------------------#--#------#--------------------#-----------------------#####---#---#--------------------------------------------------
    053:-----------------#----#-----#--------------##------###-------------------######-----#---------------#----####---------------------------------------------------
    064:---##-----------------------------------------------#-----------------------------------------------------------------------------------------------------------
    065:---##------###-----###----####-------------#-------------------------------###----------------------------------------------------------------------------------
    066:--#--#----#-------#------#----#---#-##----####------#-----####----#-###---#-------------------------------------------------------------------------------------
    067:--####-----##------##----######---##--#----#--------#----#----#---##--#----##-----------------------------------------------------------------------------------
    068:-#----#------#-------#---#--------#--------#--------#----#----#---#---#------#----------------------------------------------------------------------------------
    069:-#----#---###-----###-----####----#--------##-------#-----####----#---#---###-----------------------------------------------------------------------------------
    096:-----------------####----------------------###---#---#-------------------#####---------------------###---#---#--------------------------------------------------
    097:-----------------#---#--------------------#---#--#--#--------------------#------------------------#---#--#--#---------------------------------------------------
    098:-----------------#---#------#-------------#---#--#-#---------------------####-------#-------------#---#--#-#----------------------------------------------------
    099:-----------------#---#--------------------#---#--###---------------------#------------------------#---#--###----------------------------------------------------
    100:-----------------#---#--------------------#---#--#--#--------------------#------------------------#---#--#--#---------------------------------------------------
    101:-----------------####-------#--------------###---#---#-------------------#####------#--------------###---#---#-------------------------------------------------- |}]

let%expect_test "tim10.gb" =
  M.run_test_rom_and_print_framebuffer "timer/tim10.gb";

  [%expect{|
    A:$00 F:ZN-- BC:$0305 DE:$080D HL:$1522 SP:$E000 PC:$4B2D
    008:-####-----------------------#-----------------------------------------------------------------------------------------------------------------------------------
    009:-#---#----####---------------------###-----#------####-------------###------------------------------------------------------------------------------------------
    010:-####----#----#---##-#------#-----#-------####---#----#---#-##----#---------------------------------------------------------------------------------------------
    011:-#-#-----######--#--##------#------##------#-----######---##--#----##-------------------------------------------------------------------------------------------
    012:-#--#----#-------#---#------#--------#-----#-----#--------#----------#------------------------------------------------------------------------------------------
    013:-#---#----####----##-#------#-----###------##-----####----#-------###-------------------------------------------------------------------------------------------
    014:---------------------#------------------------------------------------------------------------------------------------------------------------------------------
    015:------------------###-------------------------------------------------------------------------------------------------------------------------------------------
    024:-------------------##----------------------##----######------------------#####--------------------####-----##---------------------------------------------------
    025:-------------------##---------------------#--#---#-----------------------#-----------------------#----#---#--#--------------------------------------------------
    026:------------------#--#------#------------#----#--#####-------------------####-------#-------------####---#----#-------------------------------------------------
    027:------------------####-------------------#----#-------#------------------#-----------------------#----#--#----#-------------------------------------------------
    028:-----------------#----#-------------------#--#---#----#------------------#-----------------------#----#---#--#--------------------------------------------------
    029:-----------------#----#-----#--------------##-----####-------------------#----------#-------------####-----##---------------------------------------------------
    032:-----------------####----------------------##-------#---------------------###-----------------------#-----####--------------------------------------------------
    033:-----------------#---#--------------------#--#-----##--------------------#---#---------------------##----#----#-------------------------------------------------
    034:-----------------####-------#------------#----#---#-#-------------------#-----------#---------------#--------#--------------------------------------------------
    035:-----------------#---#-------------------#----#--#--#-------------------#---------------------------#------##---------------------------------------------------
    036:-----------------#---#--------------------#--#---#####-------------------#---#----------------------#----#----#-------------------------------------------------
    037:-----------------####-------#--------------##-------#---------------------###-------#--------------###----####--------------------------------------------------
    040:-----------------####----------------------##-------#--------------------#####---------------------##----######-------------------------------------------------
    041:-----------------#---#--------------------#--#-----##--------------------#------------------------#--#---#------------------------------------------------------
    042:-----------------#---#------#------------#----#---#-#--------------------####-------#------------#----#--#####--------------------------------------------------
    043:-----------------#---#-------------------#----#--#--#--------------------#-----------------------#----#-------#-------------------------------------------------
    044:-----------------#---#--------------------#--#---#####-------------------#------------------------#--#---#----#-------------------------------------------------
    045:-----------------####-------#--------------##-------#--------------------#####------#--------------##-----####--------------------------------------------------
    048:-----------------#----#--------------------##-------#--------------------#--------------------------#----####---------------------------------------------------
    049:-----------------#----#-------------------#--#-----##--------------------#-------------------------##----#---#--------------------------------------------------
    050:-----------------######-----#------------#----#-----#--------------------#----------#-------------#-#----#---#--------------------------------------------------
    051:-----------------#----#------------------#----#-----#--------------------#-----------------------#--#----#---#--------------------------------------------------
    052:-----------------#----#-------------------#--#------#--------------------#-----------------------#####---#---#--------------------------------------------------
    053:-----------------#----#-----#--------------##------###-------------------######-----#---------------#----####---------------------------------------------------
    064:---##-----------------------------------------------#-----------------------------------------------------------------------------------------------------------
    065:---##------###-----###----####-------------#-------------------------------###----------------------------------------------------------------------------------
    066:--#--#----#-------#------#----#---#-##----####------#-----####----#-###---#-------------------------------------------------------------------------------------
    067:--####-----##------##----######---##--#----#--------#----#----#---##--#----##-----------------------------------------------------------------------------------
    068:-#----#------#-------#---#--------#--------#--------#----#----#---#---#------#----------------------------------------------------------------------------------
    069:-#----#---###-----###-----####----#--------##-------#-----####----#---#---###-----------------------------------------------------------------------------------
    096:-----------------####----------------------###---#---#-------------------#####---------------------###---#---#--------------------------------------------------
    097:-----------------#---#--------------------#---#--#--#--------------------#------------------------#---#--#--#---------------------------------------------------
    098:-----------------#---#------#-------------#---#--#-#---------------------####-------#-------------#---#--#-#----------------------------------------------------
    099:-----------------#---#--------------------#---#--###---------------------#------------------------#---#--###----------------------------------------------------
    100:-----------------#---#--------------------#---#--#--#--------------------#------------------------#---#--#--#---------------------------------------------------
    101:-----------------####-------#--------------###---#---#-------------------#####------#--------------###---#---#-------------------------------------------------- |}]

let%expect_test "tim11.gb" =
  M.run_test_rom_and_print_framebuffer "timer/tim11.gb";

  [%expect{|
    A:$00 F:ZN-- BC:$0305 DE:$080D HL:$1522 SP:$E000 PC:$4B2D
    008:-####-----------------------#-----------------------------------------------------------------------------------------------------------------------------------
    009:-#---#----####---------------------###-----#------####-------------###------------------------------------------------------------------------------------------
    010:-####----#----#---##-#------#-----#-------####---#----#---#-##----#---------------------------------------------------------------------------------------------
    011:-#-#-----######--#--##------#------##------#-----######---##--#----##-------------------------------------------------------------------------------------------
    012:-#--#----#-------#---#------#--------#-----#-----#--------#----------#------------------------------------------------------------------------------------------
    013:-#---#----####----##-#------#-----###------##-----####----#-------###-------------------------------------------------------------------------------------------
    014:---------------------#------------------------------------------------------------------------------------------------------------------------------------------
    015:------------------###-------------------------------------------------------------------------------------------------------------------------------------------
    024:-------------------##----------------------##----######------------------#####--------------------####-----##---------------------------------------------------
    025:-------------------##---------------------#--#---#-----------------------#-----------------------#----#---#--#--------------------------------------------------
    026:------------------#--#------#------------#----#--#####-------------------####-------#-------------####---#----#-------------------------------------------------
    027:------------------####-------------------#----#-------#------------------#-----------------------#----#--#----#-------------------------------------------------
    028:-----------------#----#-------------------#--#---#----#------------------#-----------------------#----#---#--#--------------------------------------------------
    029:-----------------#----#-----#--------------##-----####-------------------#----------#-------------####-----##---------------------------------------------------
    032:-----------------####----------------------##-------#---------------------###-----------------------#-----####--------------------------------------------------
    033:-----------------#---#--------------------#--#-----##--------------------#---#---------------------##----#----#-------------------------------------------------
    034:-----------------####-------#------------#----#---#-#-------------------#-----------#---------------#--------#--------------------------------------------------
    035:-----------------#---#-------------------#----#--#--#-------------------#---------------------------#------##---------------------------------------------------
    036:-----------------#---#--------------------#--#---#####-------------------#---#----------------------#----#----#-------------------------------------------------
    037:-----------------####-------#--------------##-------#---------------------###-------#--------------###----####--------------------------------------------------
    040:-----------------####----------------------##-------#--------------------#####---------------------##----######-------------------------------------------------
    041:-----------------#---#--------------------#--#-----##--------------------#------------------------#--#---#------------------------------------------------------
    042:-----------------#---#------#------------#----#---#-#--------------------####-------#------------#----#--#####--------------------------------------------------
    043:-----------------#---#-------------------#----#--#--#--------------------#-----------------------#----#-------#-------------------------------------------------
    044:-----------------#---#--------------------#--#---#####-------------------#------------------------#--#---#----#-------------------------------------------------
    045:-----------------####-------#--------------##-------#--------------------#####------#--------------##-----####--------------------------------------------------
    048:-----------------#----#--------------------##-------#--------------------#--------------------------#----####---------------------------------------------------
    049:-----------------#----#-------------------#--#-----##--------------------#-------------------------##----#---#--------------------------------------------------
    050:-----------------######-----#------------#----#-----#--------------------#----------#-------------#-#----#---#--------------------------------------------------
    051:-----------------#----#------------------#----#-----#--------------------#-----------------------#--#----#---#--------------------------------------------------
    052:-----------------#----#-------------------#--#------#--------------------#-----------------------#####---#---#--------------------------------------------------
    053:-----------------#----#-----#--------------##------###-------------------######-----#---------------#----####---------------------------------------------------
    064:---##-----------------------------------------------#-----------------------------------------------------------------------------------------------------------
    065:---##------###-----###----####-------------#-------------------------------###----------------------------------------------------------------------------------
    066:--#--#----#-------#------#----#---#-##----####------#-----####----#-###---#-------------------------------------------------------------------------------------
    067:--####-----##------##----######---##--#----#--------#----#----#---##--#----##-----------------------------------------------------------------------------------
    068:-#----#------#-------#---#--------#--------#--------#----#----#---#---#------#----------------------------------------------------------------------------------
    069:-#----#---###-----###-----####----#--------##-------#-----####----#---#---###-----------------------------------------------------------------------------------
    096:-----------------####----------------------###---#---#-------------------#####---------------------###---#---#--------------------------------------------------
    097:-----------------#---#--------------------#---#--#--#--------------------#------------------------#---#--#--#---------------------------------------------------
    098:-----------------#---#------#-------------#---#--#-#---------------------####-------#-------------#---#--#-#----------------------------------------------------
    099:-----------------#---#--------------------#---#--###---------------------#------------------------#---#--###----------------------------------------------------
    100:-----------------#---#--------------------#---#--#--#--------------------#------------------------#---#--#--#---------------------------------------------------
    101:-----------------####-------#--------------###---#---#-------------------#####------#--------------###---#---#-------------------------------------------------- |}]

let%expect_test "tima_reload.gb" =
  M.run_test_rom_and_print_framebuffer "timer/tima_reload.gb";

  [%expect{|
    A:$00 F:ZN-- BC:$4841 DE:$02FC HL:$FF40 SP:$E000 PC:$4B2D
    008:-####-----------------------#-----------------------------------------------------------------------------------------------------------------------------------
    009:-#---#----####---------------------###-----#------####-------------###------------------------------------------------------------------------------------------
    010:-####----#----#---##-#------#-----#-------####---#----#---#-##----#---------------------------------------------------------------------------------------------
    011:-#-#-----######--#--##------#------##------#-----######---##--#----##-------------------------------------------------------------------------------------------
    012:-#--#----#-------#---#------#--------#-----#-----#--------#----------#------------------------------------------------------------------------------------------
    013:-#---#----####----##-#------#-----###------##-----####----#-------###-------------------------------------------------------------------------------------------
    014:---------------------#------------------------------------------------------------------------------------------------------------------------------------------
    015:------------------###-------------------------------------------------------------------------------------------------------------------------------------------
    024:-------------------##--------------------#####---#####-------------------#####--------------------####-----##---------------------------------------------------
    025:-------------------##--------------------#-------#-----------------------#-----------------------#----#---#--#--------------------------------------------------
    026:------------------#--#------#------------####----####--------------------####-------#-------------####---#----#-------------------------------------------------
    027:------------------####-------------------#-------#-----------------------#-----------------------#----#--#----#-------------------------------------------------
    028:-----------------#----#------------------#-------#-----------------------#-----------------------#----#---#--#--------------------------------------------------
    029:-----------------#----#-----#------------#-------#####-------------------#----------#-------------####-----##---------------------------------------------------
    032:-----------------####--------------------#####---#####--------------------###--------------------#####---#####--------------------------------------------------
    033:-----------------#---#-------------------#-------#-----------------------#---#-------------------#-------#------------------------------------------------------
    034:-----------------####-------#------------####----####-------------------#-----------#------------####----####---------------------------------------------------
    035:-----------------#---#-------------------#-------#----------------------#------------------------#-------#------------------------------------------------------
    036:-----------------#---#-------------------#-------#-----------------------#---#-------------------#-------#------------------------------------------------------
    037:-----------------####-------#------------#-------#####--------------------###-------#------------#-------#####--------------------------------------------------
    040:-----------------####--------------------#####---#####-------------------#####-------------------#####---#####--------------------------------------------------
    041:-----------------#---#-------------------#-------#-----------------------#-----------------------#-------#------------------------------------------------------
    042:-----------------#---#------#------------####----####--------------------####-------#------------####----####---------------------------------------------------
    043:-----------------#---#-------------------#-------#-----------------------#-----------------------#-------#------------------------------------------------------
    044:-----------------#---#-------------------#-------#-----------------------#-----------------------#-------#------------------------------------------------------
    045:-----------------####-------#------------#-------#-----------------------#####------#------------#-------#####--------------------------------------------------
    048:-----------------#----#------------------#####---#####-------------------#-----------------------#####---#####--------------------------------------------------
    049:-----------------#----#------------------#-------#-----------------------#-----------------------#-------#------------------------------------------------------
    050:-----------------######-----#------------####----####--------------------#----------#------------####----####---------------------------------------------------
    051:-----------------#----#------------------#-------#-----------------------#-----------------------#-------#------------------------------------------------------
    052:-----------------#----#------------------#-------#-----------------------#-----------------------#-------#------------------------------------------------------
    053:-----------------#----#-----#------------#-------#-----------------------######-----#------------#-------#####--------------------------------------------------
    064:---##-----------------------------------------------#-----------------------------------------------------------------------------------------------------------
    065:---##------###-----###----####-------------#-------------------------------###----------------------------------------------------------------------------------
    066:--#--#----#-------#------#----#---#-##----####------#-----####----#-###---#-------------------------------------------------------------------------------------
    067:--####-----##------##----######---##--#----#--------#----#----#---##--#----##-----------------------------------------------------------------------------------
    068:-#----#------#-------#---#--------#--------#--------#----#----#---#---#------#----------------------------------------------------------------------------------
    069:-#----#---###-----###-----####----#--------##-------#-----####----#---#---###-----------------------------------------------------------------------------------
    088:-----------------####----------------------###---#---#--------------------###----------------------###---#---#--------------------------------------------------
    089:-----------------#---#--------------------#---#--#--#--------------------#---#--------------------#---#--#--#---------------------------------------------------
    090:-----------------####-------#-------------#---#--#-#--------------------#-----------#-------------#---#--#-#----------------------------------------------------
    091:-----------------#---#--------------------#---#--###--------------------#-------------------------#---#--###----------------------------------------------------
    092:-----------------#---#--------------------#---#--#--#--------------------#---#--------------------#---#--#--#---------------------------------------------------
    093:-----------------####-------#--------------###---#---#--------------------###-------#--------------###---#---#--------------------------------------------------
    096:-----------------####----------------------###---#---#-------------------#####---------------------##------##-------#-------------------------------------------
    097:-----------------#---#--------------------#---#--#--#--------------------#------------------------#--#----#--#------#-------------------------------------------
    098:-----------------#---#------#-------------#---#--#-#---------------------####-------#------------#----#--#----#-----#-------------------------------------------
    099:-----------------#---#--------------------#---#--###---------------------#-----------------------#----#--#----#-----#-------------------------------------------
    100:-----------------#---#--------------------#---#--#--#--------------------#------------------------#--#----#--#--------------------------------------------------
    101:-----------------####-------#--------------###---#---#-------------------#####------#--------------##------##-------#-------------------------------------------
    104:-----------------#----#--------------------###---#---#-------------------#-------------------------##------##-------#-------------------------------------------
    105:-----------------#----#-------------------#---#--#--#--------------------#------------------------#--#----#--#------#-------------------------------------------
    106:-----------------######-----#-------------#---#--#-#---------------------#----------#------------#----#--#----#-----#-------------------------------------------
    107:-----------------#----#-------------------#---#--###---------------------#-----------------------#----#--#----#-----#-------------------------------------------
    108:-----------------#----#-------------------#---#--#--#--------------------#------------------------#--#----#--#--------------------------------------------------
    109:-----------------#----#-----#--------------###---#---#-------------------######-----#--------------##------##-------#-------------------------------------------
    120:-#######----------------------------------------------------#------#------------------#-------------------------------------------------------------------------
    121:----#-----####-----###-----#---------------##-----####-------------#------####--------#-------------------------------------------------------------------------
    122:----#----#----#---#-------####-------------#----------#-----#------#-----#----#---#####-------------------------------------------------------------------------
    123:----#----######----##------#--------------###-----#####-----#------#-----######--#----#-------------------------------------------------------------------------
    124:----#----#-----------#-----#---------------#-----#---##-----#------#-----#-------#---##-------------------------------------------------------------------------
    125:----#-----####----###------##--------------#------###-#-----#------##-----####----###-#------------------------------------------------------------------------- |}]

let%expect_test "tima_div_write.gb" =
  M.run_test_rom_and_print_framebuffer "timer/div_write.gb";

  [%expect{|
    A:$00 F:ZN-- BC:$0305 DE:$080D HL:$1522 SP:$E000 PC:$486D
    008:-#######-----------------------------------###---#---#----------------------------------------------------------------------------------------------------------
    009:----#-----####-----###-----#--------------#---#--#--#-----------------------------------------------------------------------------------------------------------
    010:----#----#----#---#-------####------------#---#--#-#------------------------------------------------------------------------------------------------------------
    011:----#----######----##------#--------------#---#--###------------------------------------------------------------------------------------------------------------
    012:----#----#-----------#-----#--------------#---#--#--#-----------------------------------------------------------------------------------------------------------
    013:----#-----####----###------##--------------###---#---#---------------------------------------------------------------------------------------------------------- |}]

let%expect_test "tima_write_reloading.gb" =
  M.run_test_rom_and_print_framebuffer "timer/tma_write_reloading.gb";

  [%expect{|
    A:$00 F:ZN-- BC:$4841 DE:$02B8 HL:$FF40 SP:$E000 PC:$4B2D
    008:-####-----------------------#-----------------------------------------------------------------------------------------------------------------------------------
    009:-#---#----####---------------------###-----#------####-------------###------------------------------------------------------------------------------------------
    010:-####----#----#---##-#------#-----#-------####---#----#---#-##----#---------------------------------------------------------------------------------------------
    011:-#-#-----######--#--##------#------##------#-----######---##--#----##-------------------------------------------------------------------------------------------
    012:-#--#----#-------#---#------#--------#-----#-----#--------#----------#------------------------------------------------------------------------------------------
    013:-#---#----####----##-#------#-----###------##-----####----#-------###-------------------------------------------------------------------------------------------
    014:---------------------#------------------------------------------------------------------------------------------------------------------------------------------
    015:------------------###-------------------------------------------------------------------------------------------------------------------------------------------
    024:-------------------##--------------------#####---#####-------------------#####--------------------####-----##---------------------------------------------------
    025:-------------------##--------------------#-------#-----------------------#-----------------------#----#---#--#--------------------------------------------------
    026:------------------#--#------#------------####----####--------------------####-------#-------------####---#----#-------------------------------------------------
    027:------------------####-------------------#-------#-----------------------#-----------------------#----#--#----#-------------------------------------------------
    028:-----------------#----#------------------#-------#-----------------------#-----------------------#----#---#--#--------------------------------------------------
    029:-----------------#----#-----#------------#-------#####-------------------#----------#-------------####-----##---------------------------------------------------
    032:-----------------####--------------------#####---#####--------------------###--------------------#####---#####--------------------------------------------------
    033:-----------------#---#-------------------#-------#-----------------------#---#-------------------#-------#------------------------------------------------------
    034:-----------------####-------#------------####----####-------------------#-----------#------------####----####---------------------------------------------------
    035:-----------------#---#-------------------#-------#----------------------#------------------------#-------#------------------------------------------------------
    036:-----------------#---#-------------------#-------#-----------------------#---#-------------------#-------#------------------------------------------------------
    037:-----------------####-------#------------#-------#####--------------------###-------#------------#-------#####--------------------------------------------------
    040:-----------------####--------------------#####---#####-------------------#####-------------------#####---#####--------------------------------------------------
    041:-----------------#---#-------------------#-------#-----------------------#-----------------------#-------#------------------------------------------------------
    042:-----------------#---#------#------------####----####--------------------####-------#------------####----####---------------------------------------------------
    043:-----------------#---#-------------------#-------#-----------------------#-----------------------#-------#------------------------------------------------------
    044:-----------------#---#-------------------#-------#-----------------------#-----------------------#-------#------------------------------------------------------
    045:-----------------####-------#------------#-------#####-------------------#####------#------------#-------#####--------------------------------------------------
    048:-----------------#----#------------------######--#####-------------------#-----------------------#####---#####--------------------------------------------------
    049:-----------------#----#----------------------#---#-----------------------#-----------------------#-------#------------------------------------------------------
    050:-----------------######-----#---------------#----####--------------------#----------#------------####----####---------------------------------------------------
    051:-----------------#----#--------------------#-----#-----------------------#-----------------------#-------#------------------------------------------------------
    052:-----------------#----#-------------------#------#-----------------------#-----------------------#-------#------------------------------------------------------
    053:-----------------#----#-----#------------#-------#-----------------------######-----#------------#-------#####--------------------------------------------------
    064:---##-----------------------------------------------#-----------------------------------------------------------------------------------------------------------
    065:---##------###-----###----####-------------#-------------------------------###----------------------------------------------------------------------------------
    066:--#--#----#-------#------#----#---#-##----####------#-----####----#-###---#-------------------------------------------------------------------------------------
    067:--####-----##------##----######---##--#----#--------#----#----#---##--#----##-----------------------------------------------------------------------------------
    068:-#----#------#-------#---#--------#--------#--------#----#----#---#---#------#----------------------------------------------------------------------------------
    069:-#----#---###-----###-----####----#--------##-------#-----####----#---#---###-----------------------------------------------------------------------------------
    088:--------------------------------------------------------------------------###----------------------###---#---#--------------------------------------------------
    089:-------------------------------------------------------------------------#---#--------------------#---#--#--#---------------------------------------------------
    090:------------------------------------------------------------------------#-----------#-------------#---#--#-#----------------------------------------------------
    091:------------------------------------------------------------------------#-------------------------#---#--###----------------------------------------------------
    092:-------------------------------------------------------------------------#---#--------------------#---#--#--#---------------------------------------------------
    093:--------------------------------------------------------------------------###-------#--------------###---#---#--------------------------------------------------
    096:-----------------####--------------------######--#####------#------------#####-------------------######--#####------#-------------------------------------------
    097:-----------------#---#-----------------------#---#----------#------------#---------------------------#---#----------#-------------------------------------------
    098:-----------------#---#------#---------------#----####-------#------------####-------#---------------#----####-------#-------------------------------------------
    099:-----------------#---#---------------------#-----#----------#------------#-------------------------#-----#----------#-------------------------------------------
    100:-----------------#---#--------------------#------#-----------------------#------------------------#------#------------------------------------------------------
    101:-----------------####-------#------------#-------#----------#------------#####------#------------#-------#----------#-------------------------------------------
    104:-------------------------------------------------------------------------#-------------------------###---#---#--------------------------------------------------
    105:-------------------------------------------------------------------------#------------------------#---#--#--#---------------------------------------------------
    106:-------------------------------------------------------------------------#----------#-------------#---#--#-#----------------------------------------------------
    107:-------------------------------------------------------------------------#------------------------#---#--###----------------------------------------------------
    108:-------------------------------------------------------------------------#------------------------#---#--#--#---------------------------------------------------
    109:-------------------------------------------------------------------------######-----#--------------###---#---#--------------------------------------------------
    120:-#######----------------------------------------------------#------#------------------#-------------------------------------------------------------------------
    121:----#-----####-----###-----#---------------##-----####-------------#------####--------#-------------------------------------------------------------------------
    122:----#----#----#---#-------####-------------#----------#-----#------#-----#----#---#####-------------------------------------------------------------------------
    123:----#----######----##------#--------------###-----#####-----#------#-----######--#----#-------------------------------------------------------------------------
    124:----#----#-----------#-----#---------------#-----#---##-----#------#-----#-------#---##-------------------------------------------------------------------------
    125:----#-----####----###------##--------------#------###-#-----#------##-----####----###-#------------------------------------------------------------------------- |}]

let%expect_test "rapid_toggle.gb" =
  M.run_test_rom_and_print_framebuffer "timer/rapid_toggle.gb";

  [%expect{|
    A:$00 F:ZN-- BC:$4841 DE:$010C HL:$FF40 SP:$E000 PC:$4B2D
    008:-####-----------------------#-----------------------------------------------------------------------------------------------------------------------------------
    009:-#---#----####---------------------###-----#------####-------------###------------------------------------------------------------------------------------------
    010:-####----#----#---##-#------#-----#-------####---#----#---#-##----#---------------------------------------------------------------------------------------------
    011:-#-#-----######--#--##------#------##------#-----######---##--#----##-------------------------------------------------------------------------------------------
    012:-#--#----#-------#---#------#--------#-----#-----#--------#----------#------------------------------------------------------------------------------------------
    013:-#---#----####----##-#------#-----###------##-----####----#-------###-------------------------------------------------------------------------------------------
    014:---------------------#------------------------------------------------------------------------------------------------------------------------------------------
    015:------------------###-------------------------------------------------------------------------------------------------------------------------------------------
    024:-------------------##----------------------##-------#--------------------#####---------------------##------##---------------------------------------------------
    025:-------------------##---------------------#--#-----##--------------------#------------------------#--#----#--#--------------------------------------------------
    026:------------------#--#------#------------#----#---#-#--------------------####-------#------------#----#--#----#-------------------------------------------------
    027:------------------####-------------------#----#--#--#--------------------#-----------------------#----#--#----#-------------------------------------------------
    028:-----------------#----#-------------------#--#---#####-------------------#------------------------#--#----#--#--------------------------------------------------
    029:-----------------#----#-----#--------------##-------#--------------------#----------#--------------##------##---------------------------------------------------
    032:-----------------####--------------------#####---#####--------------------###----------------------##----#####--------------------------------------------------
    033:-----------------#---#-------------------#-------#-----------------------#---#--------------------#--#---#------------------------------------------------------
    034:-----------------####-------#------------####----####-------------------#-----------#------------#----#--####---------------------------------------------------
    035:-----------------#---#-------------------#-------#----------------------#------------------------#----#--#------------------------------------------------------
    036:-----------------#---#-------------------#-------#-----------------------#---#--------------------#--#---#------------------------------------------------------
    037:-----------------####-------#------------#-------#------------------------###-------#--------------##----#------------------------------------------------------
    040:-----------------####----------------------##------##--------------------#####-------------------####-----####--------------------------------------------------
    041:-----------------#---#--------------------#--#----#--#-------------------#-----------------------#---#---#----#-------------------------------------------------
    042:-----------------#---#------#------------#----#--#----#------------------####-------#------------#---#----####--------------------------------------------------
    043:-----------------#---#-------------------#----#--#----#------------------#-----------------------#---#---#----#-------------------------------------------------
    044:-----------------#---#--------------------#--#----#--#-------------------#-----------------------#---#---#----#-------------------------------------------------
    045:-----------------####-------#--------------##------##--------------------#####------#------------####-----####--------------------------------------------------
    048:-----------------#----#--------------------##-------#--------------------#--------------------------#----####---------------------------------------------------
    049:-----------------#----#-------------------#--#-----##--------------------#-------------------------##----#---#--------------------------------------------------
    050:-----------------######-----#------------#----#-----#--------------------#----------#-------------#-#----#---#--------------------------------------------------
    051:-----------------#----#------------------#----#-----#--------------------#-----------------------#--#----#---#--------------------------------------------------
    052:-----------------#----#-------------------#--#------#--------------------#-----------------------#####---#---#--------------------------------------------------
    053:-----------------#----#-----#--------------##------###-------------------######-----#---------------#----####---------------------------------------------------
    064:---##-----------------------------------------------#-----------------------------------------------------------------------------------------------------------
    065:---##------###-----###----####-------------#-------------------------------###----------------------------------------------------------------------------------
    066:--#--#----#-------#------#----#---#-##----####------#-----####----#-###---#-------------------------------------------------------------------------------------
    067:--####-----##------##----######---##--#----#--------#----#----#---##--#----##-----------------------------------------------------------------------------------
    068:-#----#------#-------#---#--------#--------#--------#----#----#---#---#------#----------------------------------------------------------------------------------
    069:-#----#---###-----###-----####----#--------##-------#-----####----#---#---###-----------------------------------------------------------------------------------
    088:-----------------####----------------------###---#---#--------------------###--------------------####-----####------#-------------------------------------------
    089:-----------------#---#--------------------#---#--#--#--------------------#---#-------------------#---#---#----#-----#-------------------------------------------
    090:-----------------####-------#-------------#---#--#-#--------------------#-----------#------------#---#---#----#-----#-------------------------------------------
    091:-----------------#---#--------------------#---#--###--------------------#------------------------#---#----#####-----#-------------------------------------------
    092:-----------------#---#--------------------#---#--#--#--------------------#---#-------------------#---#--------#-------------------------------------------------
    093:-----------------####-------#--------------###---#---#--------------------###-------#------------####-----####------#-------------------------------------------
    120:-#######----------------------------------------------------#------#------------------#-------------------------------------------------------------------------
    121:----#-----####-----###-----#---------------##-----####-------------#------####--------#-------------------------------------------------------------------------
    122:----#----#----#---#-------####-------------#----------#-----#------#-----#----#---#####-------------------------------------------------------------------------
    123:----#----######----##------#--------------###-----#####-----#------#-----######--#----#-------------------------------------------------------------------------
    124:----#----#-----------#-----#---------------#-----#---##-----#------#-----#-------#---##-------------------------------------------------------------------------
    125:----#-----####----###------##--------------#------###-#-----#------##-----####----###-#------------------------------------------------------------------------- |}]
